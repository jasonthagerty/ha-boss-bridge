name: Validate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  hacs-validation:
    runs-on: ubuntu-latest
    name: HACS Validation
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: HACS Validation
        uses: hacs/action@main
        with:
          category: integration

  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy

      - name: Run Black
        run: black --check custom_components/

      - name: Run Ruff
        run: ruff check custom_components/

      - name: Run mypy
        run: mypy custom_components/ --ignore-missing-imports
        continue-on-error: true  # mypy strict checking may fail on HA types

  create-issue-on-failure:
    runs-on: ubuntu-latest
    needs: [hacs-validation, code-quality]
    if: failure() && github.ref == 'refs/heads/main'
    permissions:
      issues: write

    steps:
    - uses: actions/checkout@v4

    - name: Create issue for validation failure
      uses: actions/github-script@v7
      with:
        script: |
          const title = `Validation Failed: ${context.workflow} - ${context.sha.substring(0, 7)}`;
          const body = `## Validation Failure Alert

          The validation workflow has failed on the main branch.

          **Workflow:** ${context.workflow}
          **Run:** ${context.runNumber}
          **Commit:** ${context.sha}
          **Actor:** @${context.actor}

          **Run URL:** ${context.payload.repository.html_url}/actions/runs/${context.runId}

          ---

          @claude please investigate this validation failure and create a PR to fix it. Check the workflow logs above and identify the root cause.

          ## Steps to investigate:
          1. Review the failing validation logs
          2. Identify the specific validation issues (black, ruff, mypy, or HACS)
          3. Determine the root cause
          4. Implement a fix
          5. Ensure all validation checks pass

          /cc @${context.actor}`;

          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'ci-failure,claude-task'
          });

          const similarIssue = issues.data.find(issue =>
            issue.title.includes(context.sha.substring(0, 7))
          );

          if (!similarIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['ci-failure', 'claude-task', 'automated']
            });
          }
